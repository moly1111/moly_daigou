# 🚀 服务器监控和故障排除完整指南

## 📋 **监控脚本说明**

### **1. 完整监控脚本 (`monitor.sh`)**
- 全面的系统健康检查
- 自动记录到日志文件
- 支持实时监控模式
- 自动生成健康报告

### **2. 快速检查脚本 (`quick_check.sh`)**
- 快速诊断常见问题
- 一键修复服务异常
- 显示详细状态信息

### **3. 定时监控脚本 (`cron_monitor.sh`)**
- 用于cron定时任务
- 每5分钟自动检查
- 异常时自动修复

## 🛠️ **服务器部署步骤**

### **步骤1: 上传脚本到服务器**
```bash
# 在服务器上创建监控目录
mkdir -p /opt/moly_daigou/scripts
cd /opt/moly_daigou/scripts

# 创建监控脚本（复制以下内容到对应文件）
```

### **步骤2: 设置脚本权限**
```bash
# 给脚本执行权限
chmod +x monitor.sh
chmod +x quick_check.sh
chmod +x cron_monitor.sh
```

### **步骤3: 创建日志目录**
```bash
# 创建日志目录
mkdir -p /opt/moly_daigou/logs
```

## 🔧 **使用方法**

### **完整监控检查**
```bash
# 执行一次完整检查
./monitor.sh check

# 启动实时监控（每5分钟检查一次）
./monitor.sh monitor

# 生成健康报告
./monitor.sh report

# 查看监控日志
./monitor.sh logs

# 查看错误日志
./monitor.sh errors

# 查看系统日志
./monitor.sh system
```

### **快速检查和修复**
```bash
# 快速检查服务状态
./quick_check.sh check

# 快速修复服务问题
./quick_check.sh fix

# 显示详细状态
./quick_check.sh status

# 清理旧日志
./quick_check.sh clean
```

### **设置定时监控**
```bash
# 编辑crontab
crontab -e

# 添加以下行（每5分钟检查一次）
*/5 * * * * /opt/moly_daigou/scripts/cron_monitor.sh

# 查看cron任务
crontab -l
```

## 📊 **日志文件说明**

### **监控日志位置**
```
/opt/moly_daigou/logs/
├── monitor.log          # 监控日志
├── error.log            # 错误日志
├── system.log           # 系统日志
├── cron_monitor.log     # 定时监控日志
├── cron_errors.log      # 定时监控错误日志
├── alerts.log           # 告警日志
└── health_report_*.txt  # 健康报告
```

### **查看日志命令**
```bash
# 查看监控日志
tail -f /opt/moly_daigou/logs/monitor.log

# 查看错误日志
tail -f /opt/moly_daigou/logs/error.log

# 查看应用日志
tail -f /opt/moly_daigou/app.log

# 查看所有日志
tail -f /opt/moly_daigou/logs/*.log
```

## 🚨 **故障排除**

### **常见问题及解决方案**

#### **问题1: 服务无法启动**
```bash
# 检查进程
ps aux | grep gunicorn

# 检查端口
ss -tlnp | grep :8080

# 检查日志
tail -50 /opt/moly_daigou/app.log

# 快速修复
./quick_check.sh fix
```

#### **问题2: 数据库连接失败**
```bash
# 检查数据库连接
cd /opt/moly_daigou
source venv/bin/activate
python3 -c "
from app import app, db
with app.app_context():
    try:
        db.session.execute(db.text('SELECT 1'))
        print('数据库连接正常')
    except Exception as e:
        print(f'数据库连接失败: {e}')
"
```

#### **问题3: 端口被占用**
```bash
# 查看端口占用
ss -tlnp | grep :8080

# 杀死占用进程
sudo fuser -k 8080/tcp

# 或者
sudo pkill -9 -f gunicorn
```

#### **问题4: 磁盘空间不足**
```bash
# 检查磁盘使用
df -h

# 清理日志文件
find /opt/moly_daigou/logs -name "*.log" -mtime +7 -delete

# 清理应用日志
find /opt/moly_daigou -name "*.log" -size +100M -delete
```

## 📈 **监控指标说明**

### **服务状态指标**
- ✅ Gunicorn进程运行状态
- ✅ 端口8080监听状态
- ✅ HTTP服务响应状态
- ✅ 数据库连接状态

### **系统资源指标**
- 📊 CPU使用率
- 📊 内存使用率
- 📊 磁盘使用率
- 📊 网络连接状态

### **应用指标**
- 📊 错误日志数量
- 📊 警告日志数量
- 📊 响应时间
- 📊 并发连接数

## 🔄 **自动化部署**

### **创建一键部署脚本**
```bash
# 创建部署脚本
cat > /opt/moly_daigou/deploy.sh << 'EOF'
#!/bin/bash
echo "🚀 开始部署..."

# 停止服务
sudo pkill -9 -f gunicorn

# 拉取代码
git pull origin main

# 安装依赖
pip install -r requirements.txt

# 数据库迁移
export FLASK_APP=app.py
flask db upgrade

# 启动服务
cd /opt/moly_daigou
source venv/bin/activate
nohup gunicorn --workers 1 --threads 8 --worker-class gthread --timeout 60 --keep-alive 5 --bind 0.0.0.0:8080 app:app > app.log 2>&1 &

# 等待启动
sleep 10

# 检查状态
./scripts/quick_check.sh check

echo "✅ 部署完成！"
EOF

chmod +x /opt/moly_daigou/deploy.sh
```

### **使用部署脚本**
```bash
# 执行部署
/opt/moly_daigou/deploy.sh

# 检查状态
/opt/moly_daigou/scripts/quick_check.sh status
```

## 📞 **紧急处理**

### **服务完全无法访问**
```bash
# 1. 检查系统状态
./monitor.sh check

# 2. 查看错误日志
./monitor.sh errors

# 3. 尝试快速修复
./quick_check.sh fix

# 4. 如果修复失败，手动重启
sudo systemctl restart nginx
sudo pkill -9 -f gunicorn
cd /opt/moly_daigou
source venv/bin/activate
nohup gunicorn --workers 1 --threads 8 --worker-class gthread --timeout 60 --keep-alive 5 --bind 0.0.0.0:8080 app:app > app.log 2>&1 &
```

### **数据库问题**
```bash
# 检查数据库连接
cd /opt/moly_daigou
source venv/bin/activate
python3 -c "
from app import app, db
with app.app_context():
    try:
        db.session.execute(db.text('SELECT 1'))
        print('数据库连接正常')
    except Exception as e:
        print(f'数据库连接失败: {e}')
"

# 如果连接失败，检查数据库服务
sudo systemctl status postgresql
# 或
sudo systemctl status mysql
```

## 🎯 **最佳实践**

### **1. 定期检查**
- 每天检查一次监控日志
- 每周生成健康报告
- 每月清理旧日志文件

### **2. 告警设置**
- 设置磁盘空间告警（>90%）
- 设置内存使用告警（>90%）
- 设置服务异常告警

### **3. 备份策略**
- 定期备份数据库
- 备份重要配置文件
- 备份应用代码

---

**现在你有了完整的监控和故障排除系统！** 🎉

这些脚本会自动记录所有信息到日志文件中，帮助你快速诊断和解决问题。
